using System;
using System.Collections.Generic;
using System.Text;
using RACTCommonClass;
using System.Collections;
using MKLibrary.MKData;

namespace RACTServer
{
    public class DeviceProcess
    {
        /// <summary>
        /// 요청을 처리 합니다.
        /// </summary>
        /// <param name="aClientRequest"></param>
        internal static void RequestProcess(RequestCommunicationData aClientRequest)
        {
            DeviceRequestInfo tRequesetInfo = aClientRequest.RequestData as DeviceRequestInfo;

            switch (tRequesetInfo.WorkType)
            {
                case E_WorkType.Search:
                    DeviceInfoReceiver(aClientRequest);
                    break;
                default:
                    ModifyDeviceInfo(aClientRequest);
                    break;
            }
        }

        /// <summary>
        /// 장비 정보를 전송할 메서드 입니다.
        /// </summary>
        /// <param name="aClientRequest"></param>
        public static void DeviceInfoReceiver(RequestCommunicationData aClientRequest)
        {
            ResultCommunicationData tResultData = null;
            DeviceInfoCollection tDeviceInfoCollection = null;
            UserInfo tUserInfo = null;
            MKDBWorkItem tDBWI = null;
            MKDataSet tDataSet = null;
            string tQueryString = "";

            try
            {
                tResultData = new ResultCommunicationData(aClientRequest);
                tUserInfo = GlobalClass.m_ClientProcess.GetUserInfo(aClientRequest.ClientID);

                tQueryString = "EXEC SP_RACT_GET_DEVICEINFO '{0}'";
                tQueryString = string.Format(tQueryString, tUserInfo.GetCenterCode);

                tDBWI = GlobalClass.m_DBPool.GetDBWorkItem();
                if (tDBWI.ExecuteQuery(tQueryString, out tDataSet) != E_DBProcessError.Success)
                {
                    System.Diagnostics.Debug.WriteLine(tDBWI.ErrorString);
                    tResultData.Error.Error = E_ErrorType.UnKnownError;
                    tResultData.Error.ErrorString = tDBWI.ErrorString;
                }
                else
                {
                    DeviceInfo tDeviceInfo;
                    tDeviceInfoCollection = new DeviceInfoCollection();

                    for (int i = 0; i < tDataSet.RecordCount; i++)
                    {
                        
                        tDeviceInfo = new DeviceInfo();
                        tDeviceInfo.DeviceID = int.Parse(tDataSet["NeID"].ToString());
                        tDeviceInfo.ModelID = tDataSet.GetInt32("ModelID");

                        

                        tDeviceInfo.Name = tDataSet["NeName"].ToString();
                        tDeviceInfo.ORG1Code = tDataSet["org1_id"].ToString();
                        tDeviceInfo.ORG2Code = tDataSet["org2_id"].ToString();
                        tDeviceInfo.BranchCode = tDataSet["org2_id"].ToString();
                        tDeviceInfo.CenterCode = tDataSet["CenterCode"].ToString();
                        tDeviceInfo.IPAddress = tDataSet["MasterIP"].ToString();
                        
                        tDeviceInfo.InputFlag = (E_FlagType)(tDataSet.GetBool("InputFlag").GetHashCode());
                        tDeviceInfo.DeviceNumber = tDataSet.GetString("devicenum");
                        tDeviceInfo.DevicePartCode = tDataSet.GetInt32("ModelTypeCode");
                        tDeviceInfo.Version = tDataSet.GetString("OsVersion");
                        tDeviceInfo.TelnetID1 = tDataSet.GetString("TelnetID_1").Trim();
                        tDeviceInfo.TelnetID2 = tDataSet.GetString("TelnetID_2").Trim();
                        tDeviceInfo.TelnetPwd1 = tDataSet.GetString("Passwd_1").Trim();
                        tDeviceInfo.TelnetPwd2 = tDataSet.GetString("Passwd_2").Trim();
                        tDeviceInfo.ORG1Name = tDataSet.GetString("ORG1_Name");
                        tDeviceInfo.ORG2Name = tDataSet.GetString("ORG2_Name");
                        tDeviceInfo.TpoName = tDataSet.GetString("TpoName");
                        tDeviceInfo.CenterName = tDataSet.GetString("BizPlsName");
                        tDeviceInfo.DeviceGroupName = tDataSet.GetString("GroupName");
                        // shinyn - 2012-12-13 - NE Group ID int -> string 수정 'B' PON(Biz) -> FOMs연동 값에 따른 수정
                        tDeviceInfo.GroupID = tDataSet.GetString("GroupID").Length > 0 ? tDataSet.GetString("GroupID") : "-1";

                        // 2013-01-11 - shinyn - 모델명 그리고 접속정보 가져오기
                        tDeviceInfo.ModelName = tDataSet.GetString("ModelName");

#if DEBUG
                        /*
                        tDeviceInfo.IPAddress = "10.30.1.58";
                        tDeviceInfo.TelnetID1 = "root";
                        tDeviceInfo.TelnetPwd1 = "vertex25";
                        */
#endif

                        tDataSet.MoveNext();

                        tDeviceInfoCollection.Add(tDeviceInfo);
                    }
                }

                System.Diagnostics.Debug.WriteLine("클라이언트에 전송하는 장비 대수 : " + tDeviceInfoCollection.Count.ToString());
                if (tDeviceInfoCollection.Count > 0) tResultData.ResultData = GlobalClass.ObjectCompress(tDeviceInfoCollection);
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine(ex.ToString());
            }
            finally
            {
				if (tDataSet != null)
                	MKOleDBClass.CloseDataSet(tDataSet);
            }

            GlobalClass.SendResultClient(tResultData);
       }

        /// <summary>
        /// 단일 장비를 수정합니다.
        /// </summary>
        /// <param name="aClientRequest"></param>
       private static void ModifyDeviceInfo(RequestCommunicationData aClientRequest)
       {
           ResultCommunicationData tResultData = null;
           DeviceRequestInfo tDeviceRequestInfo;
           DeviceInfo tDeviceInfo;

           try
           {
               tResultData = new ResultCommunicationData(aClientRequest);
               tDeviceRequestInfo = (DeviceRequestInfo)aClientRequest.RequestData;
               tDeviceInfo = tDeviceRequestInfo.DeviceInfo;

               makeQuery(tDeviceRequestInfo.WorkType,tDeviceRequestInfo.UserID, tDeviceInfo);

               tResultData.ResultData = tDeviceInfo;
               GlobalClass.SendResultClient(tResultData);
           }
           catch (Exception ex)
           {
               tResultData.Error.Error = E_ErrorType.UnKnownError;
               GlobalClass.SendResultClient(tResultData);
               Console.WriteLine(ex.Message);
           }
       }

        /// <summary>
        /// 일괄 장비 등록 기능을 수행합니다.
        /// </summary>
        /// <param name="tClientRequest"></param>
       internal static void RequestBatchRegisteration(RequestCommunicationData aClientRequest)
       {
           ResultCommunicationData tResultData = null;
           DeviceCollectionRequestInfo tDeviceCollectionRequestInfo;
           DeviceInfoCollection tDeviceInfoList;

           try
           {
               tResultData = new ResultCommunicationData(aClientRequest);
               tDeviceCollectionRequestInfo = (DeviceCollectionRequestInfo)aClientRequest.RequestData;
               tDeviceInfoList = tDeviceCollectionRequestInfo.DeviceInfoList;

               foreach(DeviceInfo tDeviceInfo in tDeviceInfoList)
               {
                   tDeviceInfo.GroupID = tDeviceCollectionRequestInfo.GroupID;
                   tDeviceInfo.TerminalConnectInfo = tDeviceCollectionRequestInfo.ConnectionInfo;
                   makeQuery(tDeviceCollectionRequestInfo.WorkType, tDeviceCollectionRequestInfo.UserID, tDeviceInfo);
               }
               tResultData.ResultData = tDeviceInfoList;
               GlobalClass.SendResultClient(tResultData);
           }
           catch (Exception ex)
           {
               tResultData.Error.Error = E_ErrorType.UnKnownError;
               GlobalClass.SendResultClient(tResultData);
               Console.WriteLine(ex.Message);
           }
       }

        /// <summary>
        /// DB로 전송할 쿼리를 만듭니다.
        /// </summary>
        /// <param name="tDeviceRequestInfo"></param>
        /// <param name="tDeviceInfo"></param>
        private static void makeQuery(E_WorkType aWorkType, int aUserID, DeviceInfo aDeviceInfo)
       {
           MKDBWorkItem tDBWI = null;
           MKDataSet tDataSet = null;
           string tQueryString = "";


           // 2013-01-18 - shinyn - 수동장비등록을 위한 프로시저 수정 적용
           // 2013-05-02 - shinyn - 수동장비등록에 프롬프트 저장 추가
           // 2013-08-09 - shinyn - MoreString, MoreMark 저장
           tQueryString = "EXEC SP_RACT_MODIFY_DEVICEINFO {0},{1},{2},{3},{4},{5},{6},'{7}',{8},{9},{10},{11},{12}," +
                          "'{13}','{14}','{15}','{16}','{17}','{18}','{19}','{20}','{21}','{22}','{23}','{24}','{25}','{26}','{27}'";

           try
           {
               switch (aDeviceInfo.DeviceType)
               {
                   case E_DeviceType.NeGroup:
                       tQueryString = string.Format(tQueryString, (int)aWorkType,
                                       aDeviceInfo.GroupID,
                                       aUserID,
                                       aDeviceInfo.DeviceID,
                                       (int)aDeviceInfo.TerminalConnectInfo.ConnectionProtocol,
                                       (int)aDeviceInfo.DeviceType,
                                       aDeviceInfo.TerminalConnectInfo.TelnetPort,
                                       aDeviceInfo.TerminalConnectInfo.SerialConfig.PortName,
                                       aDeviceInfo.TerminalConnectInfo.SerialConfig.BaudRate,
                                       aDeviceInfo.TerminalConnectInfo.SerialConfig.DataBits,
                                       (int)aDeviceInfo.TerminalConnectInfo.SerialConfig.Parity,
                                       (int)aDeviceInfo.TerminalConnectInfo.SerialConfig.StopBits,
                                       (int)aDeviceInfo.TerminalConnectInfo.SerialConfig.Handshake,
                                       "", "", "", "", "", "", "", "", "", "", "", "", "",
                                       aDeviceInfo.MoreString,
                                       aDeviceInfo.MoreMark);
                       break;
                   case E_DeviceType.UserNeGroup:
                       tQueryString = string.Format(tQueryString, (int)aWorkType,
                                       aDeviceInfo.GroupID,
                                       aUserID,
                                       aDeviceInfo.DeviceID,
                                       (int)aDeviceInfo.TerminalConnectInfo.ConnectionProtocol,
                                       (int)aDeviceInfo.DeviceType,
                                       aDeviceInfo.TerminalConnectInfo.TelnetPort,
                                       aDeviceInfo.TerminalConnectInfo.SerialConfig.PortName,
                                       aDeviceInfo.TerminalConnectInfo.SerialConfig.BaudRate,
                                       aDeviceInfo.TerminalConnectInfo.SerialConfig.DataBits,
                                       (int)aDeviceInfo.TerminalConnectInfo.SerialConfig.Parity,
                                       (int)aDeviceInfo.TerminalConnectInfo.SerialConfig.StopBits,
                                       (int)aDeviceInfo.TerminalConnectInfo.SerialConfig.Handshake,
                                       aDeviceInfo.ModelName,
                                       aDeviceInfo.IPAddress,
                                       aDeviceInfo.TelnetID1,
                                       aDeviceInfo.TelnetPwd1,
                                       aDeviceInfo.TelnetID2,
                                       aDeviceInfo.TelnetPwd2,
                                       aDeviceInfo.Name,
                                       aDeviceInfo.TpoName,
                                       aDeviceInfo.WAIT,
                                       aDeviceInfo.USERID,
                                       aDeviceInfo.PWD,
                                       aDeviceInfo.USERID2,
                                       aDeviceInfo.PWD2,
                                       aDeviceInfo.MoreString,
                                       aDeviceInfo.MoreMark);
                       break;
               }
           }
           catch (Exception ex)
           {
               System.Diagnostics.Debug.Write(ex.ToString());
           }

           tDBWI = GlobalClass.m_DBPool.GetDBWorkItem();
           if (tDBWI.ExecuteQuery(tQueryString, out tDataSet) != E_DBProcessError.Success)
           {
               Console.WriteLine(tDBWI.ExecuteQuery(tQueryString, out tDataSet));
           }
		   
		   if (tDataSet != null)
           		MKOleDBClass.CloseDataSet(tDataSet);

       }

        internal static void RequestFactDeviceSearchProcess(RequestCommunicationData aClientRequest)
        {
            ResultCommunicationData tResultData = null;
            DeviceInfoCollection tDeviceInfoCollection = new DeviceInfoCollection();
            UserInfo tUserInfo = null;
            MKDBWorkItem tDBWI = null;
            MKDataSet tDataSet = null;
            string tQueryString = "";

            try
            {
                tResultData = new ResultCommunicationData(aClientRequest);
                tUserInfo = GlobalClass.m_ClientProcess.GetUserInfo(aClientRequest.ClientID);
                DeviceSearchInfo tSearchInfo = aClientRequest.RequestData as DeviceSearchInfo;

                // 국소명으로 검색하는 기능추가
                tQueryString = "EXEC SP_RACT_GET_SearchDEVICEINFO '{0}','{1}','{2}',{3},{4},'{5}','{6}','{7}','{8}','{9}'";



                string tCenterCode = tSearchInfo.IsCheckPermission ? tUserInfo.GetCenterCode : "";


                if (tSearchInfo.SelectFACTGroupInfo != null && !tSearchInfo.SelectFACTGroupInfo.ORG1Code.Equals("0"))
                {
                    // 국소명으로 검색하는 기능추가
                    tQueryString = string.Format(tQueryString
                        , tCenterCode
                        , tSearchInfo.DeviceIPAddress
                        , tSearchInfo.DeviceName
                        , tSearchInfo.DevicePart
                        , tSearchInfo.DeviceModel
                        , tSearchInfo.ModelName
                        , tSearchInfo.SelectFACTGroupInfo.CenterCode
                        , tSearchInfo.SelectFACTGroupInfo.BranchCode
                        , tSearchInfo.SelectFACTGroupInfo.ORG1Code
                        , tSearchInfo.TpoName);

                }
                else
                {
                    // 국소명으로 검색하는 기능추가
                    tQueryString = string.Format(tQueryString,
                                                 tCenterCode,
                                                 tSearchInfo.DeviceIPAddress,
                                                 tSearchInfo.DeviceName,
                                                 tSearchInfo.DevicePart,
                                                 tSearchInfo.DeviceModel,
                                                 tSearchInfo.ModelName,
                                                 "",
                                                 "",
                                                 "",
                                                 tSearchInfo.TpoName);
                }

                tDBWI = GlobalClass.m_DBPool.GetDBWorkItem();
                if (tDBWI.ExecuteQuery(tQueryString, out tDataSet) != E_DBProcessError.Success)
                {
                    System.Diagnostics.Debug.WriteLine(tDBWI.ErrorString);
                    tResultData.Error.Error = E_ErrorType.UnKnownError;
                    tResultData.Error.ErrorString = tDBWI.ErrorString;
                }
                else
                {
                    DeviceInfo tDeviceInfo;
                    tDeviceInfoCollection = new DeviceInfoCollection();

                    // 2013-05-16- shinyn - 빠른연결 오류 발생
                    if (tDataSet.RecordCount < 1)
                    {
                        tDeviceInfoCollection.Add(new DeviceInfo());
                    }

                    for (int i = 0; i < tDataSet.RecordCount; i++)
                    {

                        tDeviceInfo = new DeviceInfo();
                        tDeviceInfo.DeviceID = int.Parse(tDataSet["NeID"].ToString());
                        tDeviceInfo.ModelID = tDataSet.GetInt32("ModelID");
                        tDeviceInfo.Name = tDataSet["NeName"].ToString();
                        tDeviceInfo.ORG1Code = tDataSet["org1_id"].ToString();
                        tDeviceInfo.ORG2Code = tDataSet["org2_id"].ToString();
                        tDeviceInfo.BranchCode = tDataSet["org2_id"].ToString();
                        tDeviceInfo.CenterCode = tDataSet["CenterCode"].ToString();
                        tDeviceInfo.IPAddress = tDataSet["MasterIP"].ToString();
                        tDeviceInfo.InputFlag = (E_FlagType)(tDataSet.GetBool("InputFlag").GetHashCode());
                        tDeviceInfo.DeviceNumber = tDataSet.GetString("devicenum");
                        tDeviceInfo.DevicePartCode = tDataSet.GetInt32("ModelTypeCode");
                        tDeviceInfo.Version = tDataSet.GetString("OsVersion");
                        tDeviceInfo.TelnetID1 = tDataSet.GetString("TelnetID_1").Trim();
                        tDeviceInfo.TelnetID2 = tDataSet.GetString("TelnetID_2").Trim();
                        tDeviceInfo.TelnetPwd1 = tDataSet.GetString("Passwd_1").Trim();
                        tDeviceInfo.TelnetPwd2 = tDataSet.GetString("Passwd_2").Trim();
                        tDeviceInfo.ORG1Name = tDataSet.GetString("ORG1_Name");
                        tDeviceInfo.ORG2Name = tDataSet.GetString("ORG2_Name");
                        tDeviceInfo.TpoName = tDataSet.GetString("TpoName");
                        tDeviceInfo.CenterName = tDataSet.GetString("BizPlsName");
                        tDeviceInfo.DeviceGroupName = tDataSet.GetString("GroupName");
                        // shinyn - 2012-12-13 - NE Group ID int -> string 수정 'B' PON(Biz) -> FOMs연동 값에 따른 수정
                        tDeviceInfo.GroupID = tDataSet.GetString("GroupID").Length > 0 ? tDataSet.GetString("GroupID") : "-1";

                        // 2013-01-11 - shinyn - 모델명 가져오기
                        tDeviceInfo.ModelName = tDataSet.GetString("ModelName");

                        // 국소명으로 조회한결과 반환
                        tDeviceInfo.TpoName = tDataSet.GetString("TpoName");

                        //장비 연결시 사용하는 변수 변경
                        // TerminalConnectInfo 를 활용할 수 있도록 수정 테스트
                        tDeviceInfo.TerminalConnectInfo.IPAddress = tDeviceInfo.IPAddress;

#if DEBUG
                        /*
                       tDeviceInfo.IPAddress = "10.30.1.58";
                       tDeviceInfo.TelnetID1 = "root";
                       tDeviceInfo.TelnetPwd1 = "vertex25";
                       */
#endif


                        tDataSet.MoveNext();

                        tDeviceInfoCollection.Add(tDeviceInfo);
                    }



                }



                System.Diagnostics.Debug.WriteLine("클라이언트에 전송하는 장비 대수 : " + tDeviceInfoCollection.Count.ToString());

                tResultData.ResultData = GlobalClass.ObjectCompress(tDeviceInfoCollection);

            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine(ex.ToString());
            }
            finally
            {
                if (tDataSet != null)
                    MKOleDBClass.CloseDataSet(tDataSet);
                tDeviceInfoCollection.Clear();
            }

            GlobalClass.SendResultClient(tResultData);
        }

       /// <summary>
       /// 2013-05-02- shinyn - 일반장비, 사용자등록장비에 따라 장비리스트 조회하기.
       /// </summary>
       /// <param name="aClientRequest"></param>
       internal static void RequestSearchDeviceForType(RequestCommunicationData aClientRequest)
       {
           ResultCommunicationData tResultData = null;
           DeviceInfoCollection tDeviceInfoCollection = new DeviceInfoCollection();
           UserInfo tUserInfo = null;
           MKDBWorkItem tDBWI = null;
           MKDataSet tDataSet = null;
           string tQueryString = "";

           try
           {
               tResultData = new ResultCommunicationData(aClientRequest);
               tUserInfo = GlobalClass.m_ClientProcess.GetUserInfo(aClientRequest.ClientID);

               // 0:장비구분 1:아이피주소 2:사용자아이디 
               string[] tArrRequest = aClientRequest.RequestData as string[];

               tQueryString = "EXEC SP_RACT_SEARCH_DEVICE_FOR_TYPE '{0}','{1}',{2}; ";
               tQueryString = string.Format(tQueryString,
                                            tArrRequest[0],
                                            tArrRequest[1],
                                            tArrRequest[2]);

               tDBWI = GlobalClass.m_DBPool.GetDBWorkItem();
               if (tDBWI.ExecuteQuery(tQueryString, out tDataSet) != E_DBProcessError.Success)
               {
                   System.Diagnostics.Debug.WriteLine(tDBWI.ErrorString);
                   tResultData.Error.Error = E_ErrorType.UnKnownError;
                   tResultData.Error.ErrorString = tDBWI.ErrorString;
               }
               else
               {
                   DeviceInfo tDeviceInfo;
                   tDeviceInfoCollection = new DeviceInfoCollection();

                   for (int i = 0; i < tDataSet.RecordCount; i++)
                   {

                       tDeviceInfo = new DeviceInfo();
                       tDeviceInfo.DeviceID = int.Parse(tDataSet["NeID"].ToString());
                       tDeviceInfo.Name = tDataSet["NeName"].ToString();

                       tDeviceInfo.IPAddress = tDataSet["MasterIP"].ToString();

                       tDeviceInfo.TelnetID1 = tDataSet.GetString("TelnetID_1").Trim();
                       tDeviceInfo.TelnetID2 = tDataSet.GetString("TelnetID_2").Trim();
                       tDeviceInfo.TelnetPwd1 = tDataSet.GetString("Passwd_1").Trim();
                       tDeviceInfo.TelnetPwd2 = tDataSet.GetString("Passwd_2").Trim();

                       tDeviceInfo.ORG2Name = tDataSet.GetString("ORG2_Name");
                       tDeviceInfo.CenterName = tDataSet.GetString("CenterName");
                       tDeviceInfo.ModelName = tDataSet.GetString("ModelName");
                       tDeviceInfo.DeviceType = (E_DeviceType)tDataSet.GetInt32("DeviceType");
                       tDeviceInfo.WAIT = tDataSet.GetString("WAIT1");
                       tDeviceInfo.USERID = tDataSet.GetString("USERID1");
                       tDeviceInfo.PWD = tDataSet.GetString("PWD1");
                       tDeviceInfo.USERID2 = tDataSet.GetString("USERID2");
                       tDeviceInfo.PWD2 = tDataSet.GetString("PWD2");

                       tDataSet.MoveNext();

                       tDeviceInfoCollection.Add(tDeviceInfo);
                   }
               }

               System.Diagnostics.Debug.WriteLine("클라이언트에 전송하는 장비 대수 : " + tDeviceInfoCollection.Count.ToString());

               tResultData.ResultData = GlobalClass.ObjectCompress(tDeviceInfoCollection);

           }
           catch (Exception ex)
           {
               System.Diagnostics.Debug.WriteLine(ex.ToString());
           }
           finally
           {
               if (tDataSet != null)
                   MKOleDBClass.CloseDataSet(tDataSet);
               tDeviceInfoCollection.Clear();
           }

           GlobalClass.SendResultClient(tResultData);
       }

       /// <summary>
       /// 2017.06.21 - NoSeungPil - RCCS 로그인 기능추가
       /// RMS CMTS 장비 정보 검색
       /// </summary>
       /// <param name="aClientRequest"></param>
       internal static void RequestSearchRMSCMTSDevice(RequestCommunicationData aClientRequest)
       {
           ResultCommunicationData tResultData = null;
           DeviceInfoCollection tDeviceInfoCollection = new DeviceInfoCollection();
           MKDBWorkItem tDBWI = null;
           MKDataSet tDataSet = null;
           string tQueryString = "";

           try
           {
               tResultData = new ResultCommunicationData(aClientRequest);
               DeviceSearchInfo tSearchInfo = aClientRequest.RequestData as DeviceSearchInfo;

               tQueryString = "SELECT TOP 1 [lgname] ,[lgpwd] FROM [FACT_MAIN].[dbo].[FOMS_RMS_CMTS_DEVICE] WHERE [cmtsid] = '{0}'; ";
               tQueryString = string.Format(tQueryString,
                                            tSearchInfo.DeviceIPAddress);

               tDBWI = GlobalClass.m_DBPool.GetDBWorkItem();
               if (tDBWI.ExecuteQuery(tQueryString, out tDataSet) != E_DBProcessError.Success)
               {
                   System.Diagnostics.Debug.WriteLine(tDBWI.ErrorString);
                   tResultData.Error.Error = E_ErrorType.UnKnownError;
                   tResultData.Error.ErrorString = tDBWI.ErrorString;
               }
               else
               {
                   DeviceInfo tDeviceInfo = new DeviceInfo();

                   if (tDataSet != null)
                   {
                       for (int i = 0; i < tDataSet.RecordCount; i++)
                       {
                           tDeviceInfo.IPAddress = tSearchInfo.DeviceIPAddress;
                           tDeviceInfo.TelnetID1 = tDataSet.GetString("lgname").Trim();
                           tDeviceInfo.TelnetPwd1 = tDataSet.GetString("lgpwd").Trim();
                       }
                   }

                   tDeviceInfoCollection.Add(tDeviceInfo);

               }

               tResultData.ResultData = GlobalClass.ObjectCompress(tDeviceInfoCollection);

           }
           catch (Exception ex)
           {
               System.Diagnostics.Debug.WriteLine(ex.ToString());
           }
           finally
           {
               if (tDataSet != null)
                   MKOleDBClass.CloseDataSet(tDataSet);
               tDeviceInfoCollection.Clear();
           }

           GlobalClass.SendResultClient(tResultData);
       }

        /// <summary>
        /// 2013-04-22 - shinyn - 여러대의 IP 장비리스트를 불러옵니다.
        /// </summary>
        /// <param name="aClientRequest"></param>
        internal static void RequestFactIPDeviceSearchProcess(RequestCommunicationData aClientRequest)
        {
            ResultCommunicationData tResultData = null;
            DeviceInfoCollection tDeviceInfoCollection = new DeviceInfoCollection();
            UserInfo tUserInfo = null;
            MKDBWorkItem tDBWI = null;
            MKDataSet tDataSet = null;
            string tQueryString = "";

            try
            {
                tResultData = new ResultCommunicationData(aClientRequest);
                tUserInfo = GlobalClass.m_ClientProcess.GetUserInfo(aClientRequest.ClientID);
                string tIPList = aClientRequest.RequestData as string;

                tQueryString = "EXEC SP_RACT_GET_SearchDEVICEINFO_IPList '{0}';";

                tQueryString = string.Format(tQueryString, tIPList);

                tDBWI = GlobalClass.m_DBPool.GetDBWorkItem();
                if (tDBWI.ExecuteQuery(tQueryString, out tDataSet) != E_DBProcessError.Success)
                {
                    System.Diagnostics.Debug.WriteLine(tDBWI.ErrorString);
                    tResultData.Error.Error = E_ErrorType.UnKnownError;
                    tResultData.Error.ErrorString = tDBWI.ErrorString;
                }
                else
                {
                    DeviceInfo tDeviceInfo;
                    tDeviceInfoCollection = new DeviceInfoCollection();

                    for (int i = 0; i < tDataSet.RecordCount; i++)
                    {

                        tDeviceInfo = new DeviceInfo();
                        tDeviceInfo.DeviceID = int.Parse(tDataSet["NeID"].ToString());
                        tDeviceInfo.ModelID = tDataSet.GetInt32("ModelID");
                        tDeviceInfo.Name = tDataSet["NeName"].ToString();
                        tDeviceInfo.ORG1Code = tDataSet["org1_id"].ToString();
                        tDeviceInfo.ORG2Code = tDataSet["org2_id"].ToString();
                        tDeviceInfo.BranchCode = tDataSet["org2_id"].ToString();
                        tDeviceInfo.CenterCode = tDataSet["CenterCode"].ToString();
                        tDeviceInfo.IPAddress = tDataSet["MasterIP"].ToString();
                        tDeviceInfo.InputFlag = (E_FlagType)(tDataSet.GetBool("InputFlag").GetHashCode());
                        tDeviceInfo.DeviceNumber = tDataSet.GetString("devicenum");
                        tDeviceInfo.DevicePartCode = tDataSet.GetInt32("ModelTypeCode");
                        tDeviceInfo.Version = tDataSet.GetString("OsVersion");
                        tDeviceInfo.TelnetID1 = tDataSet.GetString("TelnetID_1").Trim();
                        tDeviceInfo.TelnetID2 = tDataSet.GetString("TelnetID_2").Trim();
                        tDeviceInfo.TelnetPwd1 = tDataSet.GetString("Passwd_1").Trim();
                        tDeviceInfo.TelnetPwd2 = tDataSet.GetString("Passwd_2").Trim();
                        tDeviceInfo.ORG1Name = tDataSet.GetString("ORG1_Name");
                        tDeviceInfo.ORG2Name = tDataSet.GetString("ORG2_Name");
                        tDeviceInfo.TpoName = tDataSet.GetString("TpoName");
                        tDeviceInfo.CenterName = tDataSet.GetString("BizPlsName");
                        tDeviceInfo.DeviceGroupName = tDataSet.GetString("GroupName");
                        // shinyn - 2012-12-13 - NE Group ID int -> string 수정 'B' PON(Biz) -> FOMs연동 값에 따른 수정
                        tDeviceInfo.GroupID = tDataSet.GetString("GroupID").Length > 0 ? tDataSet.GetString("GroupID") : "-1";

                        // 2013-01-11 - shinyn - 모델명 가져오기
                        tDeviceInfo.ModelName = tDataSet.GetString("ModelName");


                        tDataSet.MoveNext();

                        tDeviceInfoCollection.Add(tDeviceInfo);
                    }
                }

                System.Diagnostics.Debug.WriteLine("클라이언트에 전송하는 장비 대수 : " + tDeviceInfoCollection.Count.ToString());

                tResultData.ResultData = GlobalClass.ObjectCompress(tDeviceInfoCollection);

            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine(ex.ToString());
            }
            finally
            {
                if (tDataSet != null)
                    MKOleDBClass.CloseDataSet(tDataSet);
                tDeviceInfoCollection.Clear();
            }

            GlobalClass.SendResultClient(tResultData);
        }
   }
}
